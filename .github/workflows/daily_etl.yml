name: Daily Weather ETL Pipeline

# The 'cron' schedule runs the pipeline daily at 00:00 EAT (midnight in Nairobi).
# Since GitHub Actions uses UTC, 00:00 EAT corresponds to 21:00 UTC on the previous day.
on:
  schedule:
    - cron: '0 21 * * *' 
  # Allows the job to be triggered manually from the 'Actions' tab
  workflow_dispatch:

jobs:
  run_etl:
    # Uses a GitHub-hosted runner machine
    runs-on: ubuntu-latest
    
    # Set the required environment variables:
    env:
      # 1. The API key for the ETL script
      OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
      # 2. The Personal Access Token (PAT) used for pushing the database file
      GITHUB_TOKEN: ${{ secrets.ACTIONS_PAT }} 

    steps:
      - name: â¬‡ Checkout Repository (using PAT for write access)
        # This step is modified to use the PAT, giving the runner write permission
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ACTIONS_PAT }}
      
      - name:  Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name:  Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name:  Create Data Directory
        # Ensures the data/ directory exists before the script runs
        run: mkdir -p data
        
      - name:  Run Weather ETL Script
        # Executes the ETL and updates the data/weather_data.db file
        run: python scripts/weather_etl.py
        
      - name:  Commit and Push Updated Database
        # This block checks the database file for changes and pushes it back to the repo
        run: |
          # Configure Git user details for the commit
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Stage the database file
          git add data/weather_data.db
          
          # Check if there are changes to commit (the 'if' statement prevents workflow failure)
          if ! git diff --cached --quiet; then
            # Commit changes with [skip ci] to prevent infinite workflow loops
            git commit -m "data: Automated DB update via ETL action [skip ci]"
            
            # Push the changes to the remote repository
            git push
          else
            echo "No changes detected in the database. Skipping commit."
          fi
